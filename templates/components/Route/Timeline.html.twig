<div id="route-timeline" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-6">Stop Timeline</h2>

    {% if stops is empty %}
        <div class="text-center py-12">
            <p class="text-gray-500 text-sm">No stops found for this route</p>
        </div>
    {% else %}
        {# Flowbite-style Timeline #}
        <ol class="relative border-l border-gray-300">
            {% for stop in stops %}
                <li class="{% if not loop.last %}mb-10{% endif %} ml-6">
                    {# Timeline marker #}
                    <span class="absolute flex items-center justify-center w-6 h-6 {% if stop.isTimepoint %}bg-primary-100{% else %}bg-gray-100{% endif %} rounded-full -left-3 ring-8 ring-white">
                        {% if stop.isTimepoint %}
                            <svg class="w-3 h-3 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                            </svg>
                        {% else %}
                            <svg class="w-2.5 h-2.5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="10"/>
                            </svg>
                        {% endif %}
                    </span>

                    {# Stop content #}
                    <h3 class="flex items-center mb-1 text-base font-semibold text-gray-900">
                        {{ stop.name }}
                        {% if stop.isTimepoint %}
                            <span class="bg-primary-100 text-primary-800 text-xs font-medium mr-2 px-2 py-0.5 rounded ml-2">Timepoint</span>
                        {% endif %}
                    </h3>

                    {# Approaching vehicles #}
                    {% if stop.approachingVehicles is not empty %}
                        <div class="flex flex-wrap gap-2 mt-2">
                            {% for arrival in stop.approachingVehicles %}
                                {% set nowTs = 'now'|date('U') %}
                                {% set actualEtaSec = arrival.arrivalAt - nowTs %}
                                {% set etaMin = (actualEtaSec / 60)|round %}

                                {# Determine status: arriving now or approaching #}
                                {# Note: We only predict NEXT stops, so negative ETAs indicate late vehicles, not departures #}
                                {% if actualEtaSec <= 30 %}
                                    {# At stop or arriving imminently (within 30 seconds) #}
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-success-700 bg-success-100 border border-success-300 rounded">
                                        <svg class="w-3 h-3 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                        </svg>
                                        {% if actualEtaSec < 0 %}At stop{% else %}Arriving now{% endif %}
                                    </span>
                                {% elseif etaMin <= 1 %}
                                    {# Arriving very soon (31-60 seconds) #}
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-success-700 bg-success-100 border border-success-300 rounded">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                        </svg>
                                        &lt;1 min
                                    </span>
                                {% else %}
                                    {# Approaching (> 1 min) #}
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-primary-700 bg-primary-50 border border-primary-200 rounded">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                        </svg>
                                        {{ etaMin }} min
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-xs font-normal text-gray-500 mt-2">No vehicles approaching</p>
                    {% endif %}
                </li>
            {% endfor %}
        </ol>
    {% endif %}
</div>
