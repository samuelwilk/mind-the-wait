{% extends 'base.html.twig' %}

{% block title %}Route {{ route.shortName }} - {{ route.longName }} - Saskatoon Transit{% endblock %}

{% block body %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="{{ path('app_dashboard') }}" class="hover:text-primary-500">Dashboard</a></li>
                <li><span class="mx-2">/</span></li>
                <li><a href="{{ path('app_routes_list') }}" class="hover:text-primary-500">Routes</a></li>
                <li><span class="mx-2">/</span></li>
                <li class="text-gray-900 font-medium">Route {{ route.shortName }}</li>
            </ol>
        </nav>

        <!-- Route Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 mb-8">
            <!-- Mobile Layout: Badge + Grade row, then route name -->
            <div class="sm:hidden">
                <div class="flex items-center justify-between mb-3">
                    {% include 'components/RouteBadge.html.twig' with {
                        shortName: route.shortName,
                        colour: route.colour,
                        size: 'lg'
                    } %}
                    <div class="text-right">
                        <div class="text-xs text-gray-600 mb-1">30-Day Grade</div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xl font-bold {% if routeDetail.stats.grade == 'A' or routeDetail.stats.grade == 'B' %}bg-success-100 text-success-800{% elseif routeDetail.stats.grade == 'C' %}bg-warning-100 text-warning-800{% elseif routeDetail.stats.grade == 'D' %}bg-warning-100 text-warning-800{% else %}bg-danger-100 text-danger-800{% endif %}">
                            {{ routeDetail.stats.grade }}
                        </span>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">{{ route.longName }}</h1>
                </div>
            </div>

            <!-- Desktop Layout: Badge + Name on left, Grade on right -->
            <div class="hidden sm:flex flex-row items-center justify-between gap-4">
                <div class="flex items-start gap-4 flex-1 min-w-0">
                    {% include 'components/RouteBadge.html.twig' with {
                        shortName: route.shortName,
                        colour: route.colour,
                        size: 'lg'
                    } %}
                    <div class="flex-1 min-w-0">
                        <h1 class="text-3xl font-bold text-gray-900">{{ route.longName }}</h1>
                    </div>
                </div>

                <div class="text-right flex-shrink-0">
                    <div class="text-sm text-gray-600 mb-1">30-Day Grade</div>
                    <span class="inline-flex items-center px-4 py-2 rounded-full text-2xl font-bold {% if routeDetail.stats.grade == 'A' or routeDetail.stats.grade == 'B' %}bg-success-100 text-success-800{% elseif routeDetail.stats.grade == 'C' %}bg-warning-100 text-warning-800{% elseif routeDetail.stats.grade == 'D' %}bg-warning-100 text-warning-800{% else %}bg-danger-100 text-danger-800{% endif %}">
                        {{ routeDetail.stats.grade }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Summary Statistics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-6 mb-8">
            <!-- Average Performance -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2">30-Day Average</div>
                <div class="text-2xl sm:text-3xl font-bold text-gray-900">{{ routeDetail.stats.avgPerformance }}%</div>
                <div class="text-xs text-gray-500 mt-1">Over {{ routeDetail.stats.totalDays }} days</div>
            </div>

            <!-- Best Day -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2">Best Day</div>
                <div class="text-2xl sm:text-3xl font-bold text-success-600">{{ routeDetail.stats.bestPerformance }}%</div>
                {% if routeDetail.stats.bestDay %}
                    <div class="text-xs text-gray-500 mt-1">{{ routeDetail.stats.bestDay }}</div>
                {% endif %}
            </div>

            <!-- Worst Day -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2">Worst Day</div>
                <div class="text-2xl sm:text-3xl font-bold text-danger-600">{{ routeDetail.stats.worstPerformance }}%</div>
                {% if routeDetail.stats.worstDay %}
                    <div class="text-xs text-gray-500 mt-1">{{ routeDetail.stats.worstDay }}</div>
                {% endif %}
            </div>

            <!-- Range -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                <div class="text-xs sm:text-sm font-medium text-gray-600 mb-2">Variability</div>
                <div class="text-2xl sm:text-3xl font-bold text-gray-900">{{ (routeDetail.stats.bestPerformance - routeDetail.stats.worstPerformance)|round(1) }}%</div>
                <div class="text-xs text-gray-500 mt-1">Performance range</div>
            </div>
        </div>

        <!-- Schedule Realism Card -->
        {% if routeDetail.stats.scheduleRealismGrade.value != 'insufficient_data' %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 {{ routeDetail.stats.scheduleRealismGrade.value == 'severely_under_scheduled' ? 'border-danger-500' : (routeDetail.stats.scheduleRealismGrade.value == 'under_scheduled' ? 'border-warning-500' : 'border-success-500') }} p-4 sm:p-6 mb-8">
                <div class="flex items-start">
                    <div class="flex-shrink-0 text-3xl sm:text-4xl">
                        {{ routeDetail.stats.scheduleRealismGrade.icon }}
                    </div>
                    <div class="ml-3 sm:ml-4 flex-1">
                        <div class="flex items-center justify-between">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900">Schedule Realism</h3>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {{ routeDetail.stats.scheduleRealismGrade.getColorClass }}">
                                {{ routeDetail.stats.scheduleRealismGrade.label }}
                            </span>
                        </div>
                        <div class="mt-2 text-xs sm:text-sm text-gray-700">
                            <p class="mb-2">{{ routeDetail.stats.scheduleRealismGrade.description }}</p>
                            <p class="font-medium text-gray-900">
                                <strong>Recommendation:</strong> {{ routeDetail.stats.scheduleRealismGrade.recommendation }}
                            </p>
                            {% if routeDetail.stats.scheduleRealismRatio %}
                                <p class="mt-2 text-xs text-gray-500">
                                    Ratio: {{ routeDetail.stats.scheduleRealismRatio }} (actual time / scheduled time)
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- System Comparison Panel -->
        {% if routeDetail.stats.systemComparison %}
            {% set comparison = routeDetail.stats.systemComparison %}
            <div class="bg-gray-50 rounded-lg shadow-sm border-l-4 {{ comparison.getColorClass|split(' ')[2] }} p-4 sm:p-6 mb-8">
                <div class="flex items-start">
                    <div class="flex-shrink-0 text-3xl sm:text-4xl">
                        {% if comparison.getPercentile >= 75 %}
                            üèÜ
                        {% elseif comparison.getPercentile >= 50 %}
                            üìä
                        {% elseif comparison.getPercentile >= 25 %}
                            üìâ
                        {% else %}
                            ‚ö†Ô∏è
                        {% endif %}
                    </div>
                    <div class="ml-3 sm:ml-4 flex-1">
                        <div class="flex items-center justify-between flex-wrap gap-2">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900">System Comparison</h3>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border {{ comparison.getColorClass }}">
                                {{ comparison.getRankingDescription }}
                            </span>
                        </div>
                        <div class="mt-3 space-y-2 text-xs sm:text-sm text-gray-700">
                            <p class="font-medium">
                                Route ranks <strong class="text-gray-900">#{{ comparison.routeRank }}</strong> out of
                                <strong class="text-gray-900">{{ comparison.totalRoutes }}</strong> routes
                                ({{ comparison.getPercentile|abs }}th percentile)
                            </p>
                            <p>
                                <span class="text-gray-600">Route performance:</span>
                                <strong class="text-gray-900">{{ comparison.routePerformance|round(1) }}%</strong> on-time
                            </p>
                            <p>
                                <span class="text-gray-600">System median:</span>
                                <strong class="text-gray-900">{{ comparison.systemMedianPerformance|round(1) }}%</strong> on-time
                                {% if comparison.getPerformanceDelta != 0 %}
                                    <span class="{{ comparison.getPerformanceDelta > 0 ? 'text-success-600' : 'text-danger-600' }} font-medium">
                                        ({{ comparison.getPerformanceDelta > 0 ? '+' : '' }}{{ comparison.getPerformanceDelta }}pp)
                                    </span>
                                {% endif %}
                            </p>
                            {% if comparison.isUnderperforming %}
                                <p class="mt-3 text-danger-700 font-medium">
                                    ‚ö†Ô∏è This route is significantly underperforming compared to the system average.
                                    Review schedule realism and stop-level reliability above for root causes.
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Performance Trend Chart -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-6 mb-8">
            <div
                data-controller="chart"
                data-chart-options-value="{{ routeDetail.performanceTrendChart|json_encode|e('html_attr') }}"
                style="width: 100%; height: 300px; min-height: 300px; position: relative; z-index: 1;">
            </div>
        </div>

        <!-- Stop-Level Reliability Charts (Direction Split) -->
        {% if routeDetail.stopReliabilityChartDirection0 or routeDetail.stopReliabilityChartDirection1 %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-6 mb-8">
                <div class="mb-4 px-3">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Stop-Level Reliability by Direction</h2>
                    <p class="text-xs sm:text-sm text-gray-600">
                        Shows how delays accumulate along each route direction. Stops are ordered from start to end of the route.
                        Arrows indicate direction of travel (‚Üì outbound, ‚Üë inbound).
                    </p>
                </div>

                <!-- Grid layout: 2 columns on desktop, 1 column on mobile -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                    {% if routeDetail.stopReliabilityChartDirection0 %}
                        <div
                            data-controller="chart"
                            data-chart-options-value="{{ routeDetail.stopReliabilityChartDirection0|json_encode|e('html_attr') }}"
                            style="width: 100%; height: 500px; min-height: 500px; position: relative; z-index: 1;"
                            class="sm:!h-[400px] sm:!min-h-[400px]">
                        </div>
                    {% endif %}

                    {% if routeDetail.stopReliabilityChartDirection1 %}
                        <div
                            data-controller="chart"
                            data-chart-options-value="{{ routeDetail.stopReliabilityChartDirection1|json_encode|e('html_attr') }}"
                            style="width: 100%; height: 500px; min-height: 500px; position: relative; z-index: 1;"
                            class="sm:!h-[400px] sm:!min-h-[400px]">
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Weather Impact and Time-of-Day Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mb-8">
            <!-- Weather Impact Chart -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-6">
                <div
                    data-controller="chart"
                    data-chart-options-value="{{ routeDetail.weatherImpactChart|json_encode|e('html_attr') }}"
                    style="width: 100%; height: 300px; min-height: 300px; position: relative; z-index: 1;">
                </div>
            </div>

            <!-- Time-of-Day Heatmap -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sm:p-6">
                <div
                    data-controller="chart"
                    data-chart-options-value="{{ routeDetail.timeOfDayHeatmap|json_encode|e('html_attr') }}"
                    style="width: 100%; height: 300px; min-height: 300px; position: relative; z-index: 1;">
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="bg-gradient-to-r from-primary-50 to-primary-100 border border-primary-200 rounded-lg p-4 sm:p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 sm:h-8 sm:w-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-3 sm:ml-4">
                    <h3 class="text-base sm:text-lg font-semibold text-primary-900">Route Analysis</h3>
                    <div class="mt-2 text-xs sm:text-sm text-primary-800 space-y-2">
                        <p>
                            Route {{ route.shortName }} averages <strong>{{ routeDetail.stats.avgPerformance }}%</strong> on-time performance over the last 30 days, earning a grade of <strong>{{ routeDetail.stats.grade }}</strong>.
                        </p>
                        {% if routeDetail.stats.bestPerformance - routeDetail.stats.worstPerformance > 30 %}
                            <p>
                                This route shows <strong>high variability</strong> in performance ({{ (routeDetail.stats.bestPerformance - routeDetail.stats.worstPerformance)|round(1) }}% range),
                                suggesting external factors like weather significantly impact service quality.
                            </p>
                        {% endif %}
                        <p class="mt-4">
                            <a href="{{ path('app_weather') }}" class="font-semibold text-primary-700 hover:text-primary-800 underline">
                                View weather impact analysis ‚Üí
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# Track route view event in Google Analytics #}
    {% if app.environment == 'prod' and app.request.server.get('GA4_MEASUREMENT_ID') %}
        <script>
            if (typeof gtag !== 'undefined' && localStorage.getItem('analytics-consent') === 'granted') {
                gtag('event', 'view_route', {
                    'route_id': '{{ route.gtfsId }}',
                    'route_number': '{{ route.shortName }}',
                    'route_name': '{{ route.longName }}',
                    'route_grade': '{{ routeDetail.stats.grade }}',
                    'avg_performance': {{ routeDetail.stats.avgPerformance }}
                });
            }
        </script>
    {% endif %}
{% endblock %}
