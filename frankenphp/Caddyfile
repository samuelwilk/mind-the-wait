{
	{$CADDY_GLOBAL_OPTIONS}

	frankenphp {
		{$FRANKENPHP_CONFIG}
	}

	# https://caddyserver.com/docs/caddyfile/directives#sorting-algorithm
	order mercure after encode
	order vulcain after reverse_proxy
}

{$CADDY_EXTRA_CONFIG}

# Listen on port 8080 for ALB health checks
:8080

log {
	# Redact the authorization query parameter that can be set by Mercure
	format filter {
		wrap console
		fields {
			uri query {
				replace authorization REDACTED
			}
		}
	}
}

# HTTP server for internal metrics - disabled due to FrankenPHP parsing error
# The :2019 directive is not recognized by this version of FrankenPHP
# :2019 {
# 	metrics /metrics
# }

# Main application server
route {
	# Mercure Hub (disabled - requires JWT configuration)
	# mercure {
	# 	transport_url {$MERCURE_TRANSPORT_URL:bolt:///data/mercure.db}
	# 	publisher_jwt {env.MERCURE_PUBLISHER_JWT_KEY} {env.MERCURE_PUBLISHER_JWT_ALG}
	# 	subscriber_jwt {env.MERCURE_SUBSCRIBER_JWT_KEY} {env.MERCURE_SUBSCRIBER_JWT_ALG}
	# 	anonymous
	# 	subscriptions
	# 	{$MERCURE_EXTRA_DIRECTIVES}
	# }

	# Vulcain (disabled - not needed for production)
	# vulcain

	# Add trailing slash for directory URLs
	@canonicalPath {
		file {path}/index.php
		not path */
	}
	redir @canonicalPath {path}/ 308

	# If the requested file does not exist, try index files
	@indexFiles file {
		try_files {path} {path}/index.php index.php
		split_path .php
	}
	rewrite @indexFiles {http.matchers.file.relative}

	# FrankenPHP!
	@phpFiles path *.php
	php @phpFiles
	encode zstd br gzip

	# Security headers
	header {
		# Disable FLoC tracking
		Permissions-Policy interest-cohort=()
		# Enable HSTS (uncomment after testing HTTPS works)
		# Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# Disable clients from sniffing the media type
		X-Content-Type-Options nosniff
		# Clickjacking protection
		X-Frame-Options DENY
		# Keep referrer data off of HTTP connections
		Referrer-Policy no-referrer-when-downgrade
		-Server
		-X-Powered-By
	}

	# Deny access to sensitive files
	@dotFiles path */.*
	handle @dotFiles {
		respond 403
	}

	file_server {
		# Enable compression
		precompressed br gzip
	}
}
